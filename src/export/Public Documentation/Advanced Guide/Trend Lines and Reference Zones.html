<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>Trend Lines and Reference Zones</title><style>
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	text-indent: -1.7em;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark-href {
	font-size: 0.75em;
	opacity: 0.5;
}

.sans { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, KaiTi, STKaiTi, '华文楷体', KaiTi_GB2312, '楷体_GB2312', serif; }
.mono { font-family: Nitti, 'Microsoft YaHei', '微软雅黑', monospace; }
.pdf .sans { font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC', 'Noto Sans CJK KR'; }

.pdf .code { font-family: Source Code Pro, 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC', 'Noto Sans Mono CJK KR'; }

.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, KaiTi, STKaiTi, '华文楷体', KaiTi_GB2312, '楷体_GB2312', serif, 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC', 'Noto Sans CJK KR'; }

.pdf .mono { font-family: PT Mono, Nitti, 'Microsoft YaHei', '微软雅黑', monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC', 'Noto Sans Mono CJK KR'; }

.highlight-default {
}
.highlight-gray {
	color: rgb(155,154,151);
}
.highlight-brown {
	color: rgb(100,71,58);
}
.highlight-orange {
	color: rgb(217,115,13);
}
.highlight-yellow {
	color: rgb(223,171,1);
}
.highlight-teal {
	color: rgb(15,123,108);
}
.highlight-blue {
	color: rgb(11,110,153);
}
.highlight-purple {
	color: rgb(105,64,165);
}
.highlight-pink {
	color: rgb(173,26,114);
}
.highlight-red {
	color: rgb(224,62,62);
}
.highlight-gray_background {
	background: rgb(235,236,237);
}
.highlight-brown_background {
	background: rgb(233,229,227);
}
.highlight-orange_background {
	background: rgb(250,235,221);
}
.highlight-yellow_background {
	background: rgb(251,243,219);
}
.highlight-teal_background {
	background: rgb(221,237,234);
}
.highlight-blue_background {
	background: rgb(221,235,241);
}
.highlight-purple_background {
	background: rgb(234,228,242);
}
.highlight-pink_background {
	background: rgb(244,223,235);
}
.highlight-red_background {
	background: rgb(251,228,228);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(55, 53, 47, 0.6);
	fill: rgba(55, 53, 47, 0.6);
}
.block-color-brown {
	color: rgb(100,71,58);
	fill: rgb(100,71,58);
}
.block-color-orange {
	color: rgb(217,115,13);
	fill: rgb(217,115,13);
}
.block-color-yellow {
	color: rgb(223,171,1);
	fill: rgb(223,171,1);
}
.block-color-teal {
	color: rgb(15,123,108);
	fill: rgb(15,123,108);
}
.block-color-blue {
	color: rgb(11,110,153);
	fill: rgb(11,110,153);
}
.block-color-purple {
	color: rgb(105,64,165);
	fill: rgb(105,64,165);
}
.block-color-pink {
	color: rgb(173,26,114);
	fill: rgb(173,26,114);
}
.block-color-red {
	color: rgb(224,62,62);
	fill: rgb(224,62,62);
}
.block-color-gray_background {
	background: rgb(235,236,237);
}
.block-color-brown_background {
	background: rgb(233,229,227);
}
.block-color-orange_background {
	background: rgb(250,235,221);
}
.block-color-yellow_background {
	background: rgb(251,243,219);
}
.block-color-teal_background {
	background: rgb(221,237,234);
}
.block-color-blue_background {
	background: rgb(221,235,241);
}
.block-color-purple_background {
	background: rgb(234,228,242);
}
.block-color-pink_background {
	background: rgb(244,223,235);
}
.block-color-red_background {
	background: rgb(251,228,228);
}

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="7260ffda-75c2-45c0-9ba3-65db9e6c0bde" class="page sans"><header><h1 class="page-title"><strong>Trend Lines and Reference Zones</strong></h1></header><div class="page-body"><p id="627ce301-33a3-4faa-a741-dfcec09c90b2" class=""><strong>Table of Contents</strong><div class="indented"><nav id="c166a8c8-7713-454b-99cf-0e98ec978dc7" class="block-color-gray table_of_contents"><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#8a02170b-e7fb-4dc2-ba52-6e5da53dc1b6"><strong>A Single Reference Line</strong></a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#4c77eebe-c531-4aff-8370-9d4118f391c5"><strong>Implicit encoding and resolving encoding for composed layer</strong></a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#b665c357-6eb2-478f-9dea-f74c8d2911e2"><strong>Encoding transform</strong></a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#d6664394-9874-4347-8b7d-e64f4cc18810"><strong>Reusablility</strong></a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#585a4564-790c-4000-b44b-a46a9b7c3d05"><strong>Wrapping up</strong></a></div></nav></div></p><hr id="2b3d6124-8b5f-4e94-befd-fa2d94c44271"/><p id="252b0a69-d449-406a-8d70-3374fc0339c9" class="">This tutorial provides an intuitive understanding of how any kind of trend / reference lines / zone can be created. Having the power of <mark class="highlight-blue"><a href="https://muzejs.org/docs/composing-layers">layers</a></mark> provides you with all the necessary tools required to create reference zones and trend lines.</p><p id="59e1fcec-885b-44f9-b9c4-34a08b823a3e" class="">You can read about <mark class="highlight-blue"><a href="https://muzejs.org/docs/composing-layers#creating-multiple-layers-with-different-data-source-with-different-data-source">composing layers</a></mark> to know what it is capable of doing.</p><h2 id="8a02170b-e7fb-4dc2-ba52-6e5da53dc1b6" class=""><strong>A Single Reference Line</strong></h2><p id="8608056f-2966-4d7d-8aae-b5069c4cceaa" class="">Let&#x27;s create a single reference line on a bar chart, in our case, the average mileage throughout all the years. Scroll down to see the end result we are gonna achieve.</p><p id="c5efaac7-3c08-4ce8-95fd-98f8cb271a39" class="">In order to get a reference line, we need to create a <strong>tick layer</strong> for drawing the line and a <strong>text layer</strong> to draw any kind of text to annotate the line.</p><ul id="b91b0947-bf62-4822-8685-583ed4fb6c12" class="bulleted-list"><li>First we have to calculate average value of all data points to show the average line.<p id="eff8bddc-bc5a-4daa-9d6d-b34b5a2fe1c3" class="">Canvas supports <code>transform</code> method which allows creation of additional data required for rendering from the root data using <mark class="highlight-blue"><a href="https://muzejs.org/docs/datamodel-operators">operators</a></mark>. A visualization can have multiple layers. Layers can have same or different data source. All the layers take instance of <mark class="highlight-blue"><a href="https://muzejs.org/docs/introduction-to-datamodel">DataModel</a></mark> as source of data.</p><p id="1d2c0e08-22c4-4a17-8dba-b433dc9d6803" class="">The reference line layer shows the average value of <em>Horsepower</em> across the years, hence it needs an instance of <mark class="highlight-blue"><a href="https://muzejs.org/docs/introduction-to-datamodel">DataModel</a></mark> which holds the average value. Here we are gonna transform the root DataModel instance to retrieve an instance of DataModel which holds the average value and give it a name so that we can refer it some other place.</p><pre id="dbbc0e19-eb58-428d-adbf-21820f806dd5" class="code"><code>canvas
    .transform({
        calculatedAverage: dt =&gt; dt.groupBy([&#x27;&#x27;], { Miles_per_Gallon: &#x27;avg&#x27; })
    })</code></pre></li></ul><ul id="5935f828-de77-4193-9a03-3ac2e8a10bde" class="bulleted-list"><li>We&#x27;ll start by creating a defining a composition of the reference line. Look at the final chart and think what is the line composed of. Obviously, it renders a line and text. So lets define the reference line<pre id="042928ff-ffaf-457e-a3fc-955b746e0359" class="code"><code>layerFactory.composeLayers(&#x27;referenceLine&#x27;, [ averageLine, averageText ])</code></pre><p id="4efd59e6-35a7-4d77-8175-ed5b4a1bbfe4" class=""><code>layerFactory</code> takes the definition of custom layers. It accepts a name for the newly created composite layer and definition in terms of atomic or another custom layer.</p><p id="3e3a277e-f86e-40bd-96e0-11f83808c7a0" class="">We haven&#x27;t yet defined what <code>averageLine</code> and <code>averageText</code> are supposed to be. So our next step is to define each of them</p></li></ul><ul id="e68f3ec4-a11f-4421-b4b3-e7f9c27bf543" class="bulleted-list"><li>We&#x27;ll define individual layers:<ul id="9243f003-c6f7-489e-8bfe-60fea81272d5" class="bulleted-list"><li>First we&#x27;ll use a <code>tick</code> layer which gives us average line. The average value is already calculated in step 1, we just need to pass the name of the DataModel containing average value to layers. We use <code>source</code> property to pass the data source for a layer.</li></ul><pre id="a48242d5-11b5-4451-8299-5b2b7280bba5" class="code"><code>const averageLine = {
    name: &#x27;averageLine&#x27;,
    mark: &#x27;tick&#x27;,
    source: &#x27;calculatedAverage&#x27;,
    className: &#x27;average-line&#x27;,
    encoding: {
        y: &#x27;referenceLine.encoding.y&#x27;,
        x: null
    }
}</code></pre><ul id="11da8b02-bf37-4388-84f4-60597bdc6368" class="bulleted-list"><li>Then we&#x27;ll describe the text layer which will give us the display the average in text format.</li></ul><pre id="b2f87c47-b469-4507-a050-fb764a9e430b" class="code"><code>const averageText = {
    name: &#x27;averageText&#x27;,
    mark: &#x27;text&#x27;,
    source: &#x27;calculatedAverage&#x27;,
    className: &#x27;averageText&#x27;,
    encoding: {
        y: &#x27;referenceLine.encoding.y&#x27;,
        text: &#x27;referenceLine.encoding.text&#x27;
    }
}</code></pre><ul id="3111eafc-bca4-4fc6-83d4-defdc9ec1f6e" class="bulleted-list"><li>Now that we created everything we need, we&#x27;ll now use this composite layer along with the simple bar layer in the canvas</li></ul><pre id="ebef6c2f-152a-4ee4-98d5-025cded7e204" class="code"><code>canvas
    .layers([
        { mark: &#x27;bar&#x27; },
        {
            mark: &#x27;referenceLine&#x27;,
            encoding: {
                text: { field: &#x27;Horsepower&#x27; }
        }
    }
])</code></pre></li></ul><p id="c756e564-9d12-4a56-a23c-3bdc0b9b8291" class="">The text encoding is Miles Per Gallon to display the average mileage.</p><figure id="efdcfa29-0b57-4284-b9c7-85c5530b40e5" class="image"><a href="https://muzejs.org/static/images/copy.svg"><img style="width:48px" src="https://muzejs.org/static/images/copy.svg"/></a></figure><pre id="828ee507-e33c-4ef9-82cf-369c8c030b7b" class="code"><code>// DataModel instance is created from https://muzejs.org/static/cars.json data,
// https://muzejs.org/static/cars-schema.json schema and assigned to variable rootDM.
 
let layerFactory = muze.layerFactory

layerFactory.composeLayers(&#x27;referenceLine&#x27; /* name of composite layer */, [
    {
        name: &#x27;averageLine&#x27;, // Name of the line layer only
        mark: &#x27;tick&#x27;, // Defines what kind of plot to be used
        source: &#x27;calulatedAverage&#x27;, // Defines datasource from which it gets the data
        className: &#x27;average-line&#x27;, // CSS class name which the layer appends on group
        encoding: {
            y: &#x27;referenceLine.encoding.y&#x27;,
            x: null,
            color: { value: () =&gt; &#x27;#414141&#x27; }
        },
        calculateDomain: false // Dont calculate domain of axis from this layer
    },
    {
        name: &#x27;averageText&#x27;,
        mark: &#x27;text&#x27;,
        source: &#x27;calulatedAverage&#x27;,
        className: &#x27;average-text&#x27;,
        encoding: {
            y: &#x27;referenceLine.encoding.y&#x27;,
            text: &#x27;referenceLine.encoding.text&#x27;,
            color: { value: () =&gt; &#x27;#414141&#x27; },
        },
        encodingTransform: (points, layer, dependencies) =&gt; { /* Use this to change text position */
            let width = layer.measurement().width;
            let smartLabel = dependencies.smartLabel;
            for (let i = 0; i &lt; points.length; i++) {
                let size = smartLabel.getOriSize(points[i].text);
                points[i].update.x = width - 5;
                points[i].textanchor = &#x27;end&#x27;;
                points[i].update.y -= size.height / 2;
            }
            return points;
        },
        calculateDomain: false /* No calculation of domain from this layer */
    }
]);
// Create an environment for future rendering
let env = muze();
// Create an instance of canvas which houses the visualization
let canvas = env.canvas();

canvas
    .rows([&#x27;Horsepower&#x27;])
    .columns([&#x27;Year&#x27;])
    .data(rootData)
    .transform({ calulatedAverage: (dt) =&gt; dt.groupBy([&#x27;&#x27;], { Miles_per_Gallon: &#x27;avg&#x27; }) })
    .layers([
        { mark: &#x27;bar&#x27; }, 
        {
            mark: &#x27;referenceLine&#x27;,
            encoding: {
                text: {
                    field: &#x27;Horsepower&#x27;,
                    formatter: value =&gt; `Average Horsepower: ${Math.round(value)}`
                }
            }
        }
    ])
    .width(600)
    .height(400)
    .title(&#x27;A Reference Line&#x27;)
    .mount(&#x27;#chart-container&#x27;);</code></pre><h3 id="4c77eebe-c531-4aff-8370-9d4118f391c5" class=""><strong>Implicit encoding and resolving encoding for composed layer</strong></h3><p id="80e76c1f-d1b3-4829-aea5-8b16dde60719" class="">In the above sample the definition of <code>averageLine</code> or <code>averageText</code> is explained in the code with comments</p><pre id="84c22ee6-5387-42b5-a19a-38b9dfec5092" class="code"><code>{
    name: &#x27;averageLine&#x27;, // Name of the line layer only
    mark: &#x27;tick&#x27;, // Defines what kind of plot to be used
    source: &#x27;calulatedAverage&#x27;, // Defines datasource from which it gets the data
    className: &#x27;average-line&#x27;, // CSS class name which the layer appends on group
    encoding: {
        y: &#x27;referenceLine.encoding.y&#x27;,
        x: null,
        color: { value: () =&gt; &#x27;#414141&#x27; }
    },
    calculateDomain: false // Dont calculate domain of axis from this layer
},</code></pre><p id="c7fb0456-71cd-4b46-a0a0-b011307ce715" class="">But it feels like, there is something weird going on with the <code>encoding</code> object. We have seen <code>encoding</code> object before in <code>layers</code> method</p><pre id="9dc8bf84-6088-4de2-9f95-b7418e9dd540" class="code"><code>canvas.layers([{
    mark: &#x27;bar&#x27;,
    encoding: {
        y: &#x27;Horsepower&#x27;,
        x: &#x27;Year&#x27;,
        color: { value: () =&gt; &#x27;#000000&#x27; }
    }
}])</code></pre><p id="730afd7f-e849-4159-b11c-5329e4108f94" class="">Here using <code>encoding</code> we determine how y value (height of a bar) and x value (x position of a bar) are calculated for a point. Like, in the above example, we are essentially telling muze to calculate the height of a bar from the value of <em>Horsepower</em> field in DataModel instance. Similarly, we are assigning a static color to the plot using <code>color</code> property.</p><p id="49048a67-ae29-4bd5-be2b-4c8ab545eb43" class="">Lets see how <code>layers</code> for the reference line example looks like</p><pre id="9c01a1c1-dc16-4fcf-bc83-4e47637dd433" class="code"><code>.layers([
    { mark: &#x27;bar&#x27; }, 
    {
        mark: &#x27;referenceLine&#x27;,
        encoding: {
            text: {
                field: &#x27;Horsepower&#x27;,
                formatter: value =&gt; `Average Horsepower: ${Math.round(value)}`}
        }
    }
])</code></pre><p id="7fb09013-a020-4e43-a84e-4e2aecd2d606" class="">Here we have not mentioned <code>x</code>, <code>y</code> in <code>encoding</code> but it still works. This is because Muze internally populates <code>x</code> and <code>y</code> encoding from <code>rows</code> and <code>columns</code>, if you don&#x27;t provide it from outside. Muze internally translates the config to</p><pre id="175ca8bf-8a3a-40d5-9785-8a5362c8d5d4" class="code"><code>.layers([
    { 
        mark: &#x27;bar&#x27;,
        encoding: {
            y: &#x27;Horsepower&#x27;,
            x: &#x27;Year&#x27;
        }
    }, 
    {
        mark: &#x27;referenceLine&#x27;,
        encoding: {
            text: {
                y: &#x27;Horsepower&#x27;,
                x: &#x27;Year&#x27;,
                field: &#x27;Horsepower&#x27;,
                formatter: value =&gt; `Average Horsepower: ${Math.round(value)}`}
        }
    }
])</code></pre><p id="409b3a8c-8f82-494b-a6b5-736b27ea140f" class="">Now have a look at the newly composed <code>averageLine</code> layer&#x27;s encoding</p><pre id="09567ffd-03c5-409f-b6d8-eaa597c6ec4a" class="code"><code>encoding: {
    y: &#x27;referenceLine.encoding.y&#x27;,
    x: null,
    color: { value: () =&gt; &#x27;#414141&#x27; }
},</code></pre><p id="150810f8-932a-4202-b51f-78ebd5dc972b" class="">Here for a composed layer we dont have the field&#x27;s name from DataModel instance as <code>y</code> encoding value, it has some weird dot notation. Composed layers wont get access to DataModel&#x27;s instance field directly. It has to be accessed through a path <code>referenceLine.encoding.y</code>. Refer the following image to understand the reference mechanism.</p><figure id="705658e7-570a-4172-bc22-24bca9f6ef8f" class="image"><a href="https://muzejs.org/static/docs_images/trendlines/composed-layer-encoding-resolving.png"><img src="https://muzejs.org/static/docs_images/trendlines/composed-layer-encoding-resolving.png"/></a></figure><p id="98d41d17-61f1-4bc0-8a47-f21490407733" class="">The left hand side code block is for composing layers where as the right hand side&#x27;s code block is for layer definition. Check the color mapping in the image to understand how we are referring members from one section to another.</p><p id="8a9cb089-9a8a-47fe-977c-cc148e678e3a" class="">For example when <code>referenceLine.encoding.text</code> for <code>referenceLine</code> from the left block is getting resolved, it gets the value from <code>{ ... , encoding: { text: ... }}</code> for layer which has <code>referenceLine</code> mark.</p><h3 id="b665c357-6eb2-478f-9dea-f74c8d2911e2" class=""><strong>Encoding transform</strong></h3><p id="67d8b410-f3e9-41cd-b97c-a84af97ee903" class="">Once layer finish computing value for a encoding , we might need to change the value for various reasons, like change x, y to eliminate overlapping, change color to improve readability etc...</p><p id="df6833ef-f8be-4bb6-bcd7-4a3337bf39ac" class="">In all those cases you can use <code>encodingTransform</code> to further transform the encoding of points. Here in the example, <code>encodingTransform</code> pushes the text towards right margin and leaves a padding between line and text.</p><p id="ddf645f1-4b82-47d4-adda-176beb2be42d" class="">You can remove the property from configuration and see what happens if you don&#x27;t provide <code>encodingTransform</code>.</p><h2 id="d6664394-9874-4347-8b7d-e64f4cc18810" class=""><strong>Reusablility</strong></h2><p id="b45a09eb-13f7-4829-81d3-574b191b38bf" class="">If you notice the code to draw average line example carefully, you will realize that definition of custom layers are completely independent from the rest of the system. This is an immensely powerful feature with versatile use case.</p><p id="bc95a716-3871-4796-99d0-109c7bc6fe4c" class="">You might have complex plot definitions, annotations, markers saved as separate file as store, serve it to different visualization system and have it attached to any visualization you want.</p><h2 id="585a4564-790c-4000-b44b-a46a9b7c3d05" class=""><strong>Wrapping up</strong></h2><p id="74ab1e8f-8538-40f3-8046-53e28fdaac77" class="">By now you probably have some understanding how powerful Muze&#x27;s layers are. We will discuss layers in more details <mark class="highlight-blue"><a href="https://muzejs.org/docs/composing-layers">here</a></mark>. In the <mark class="highlight-blue"><a href="https://muzejs.org/docs/Tooltips">next tutorial</a></mark> we will see how can we customize tooltip.</p><p id="9b260663-ee5d-498d-96a2-125f6a1399c9" class="">
</p></div></article></body></html>